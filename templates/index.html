<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Detection Web App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ˜Š Emotion Detection System</h1>
            <p>Detect emotions from images or live webcam</p>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="upload">Upload Image</button>
            <button class="tab-btn" data-tab="webcam">Webcam</button>
            <button class="tab-btn" data-tab="history">History</button>
            <button class="tab-btn" data-tab="stats">Statistics</button>
        </nav>

        <!-- Upload Tab -->
        <div id="upload" class="tab-content active">
            <div class="upload-section">
                <input type="text" id="name-input" placeholder="Enter your name (optional)">
                
                <div class="upload-area" id="upload-area">
                    <svg class="upload-icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    <p>Drag and drop an image here or click to select</p>
                    <input type="file" id="file-input" accept="image/*" style="display:none;">
                </div>

                <div id="upload-result" class="result-container"></div>
            </div>
        </div>

        <!-- Webcam Tab -->
        <div id="webcam" class="tab-content">
            <div class="webcam-section">
                <input type="text" id="webcam-name" placeholder="Enter your name (optional)">
                
                <div class="webcam-container">
                    <video id="video" width="400" height="300" autoplay></video>
                    <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
                </div>

                <div class="webcam-controls">
                    <button id="start-webcam" class="btn">Start Webcam</button>
                    <button id="capture" class="btn" style="display:none;">Capture</button>
                    <button id="stop-webcam" class="btn" style="display:none;">Stop</button>
                </div>

                <div id="webcam-result" class="result-container"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="history-section">
                <h2>Detection History</h2>
                <div id="history-list" class="history-list"></div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats" class="tab-content">
            <div class="stats-section">
                <h2>Statistics</h2>
                <div id="stats-content" class="stats-content"></div>
            </div>
        </div>
    </div>

    <script>
        const emotions = ["Angry", "Disgusted", "Fearful", "Happy", "Neutral", "Sad", "Surprised"];
        const colors = {
            "Angry": "#FF6B6B",
            "Disgusted": "#95E77D",
            "Fearful": "#FFD93D",
            "Happy": "#6BCB77",
            "Neutral": "#9D84B7",
            "Sad": "#4D96FF",
            "Surprised": "#FF9FF3"
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                if (btn.dataset.tab === 'history') loadHistory();
                if (btn.dataset.tab === 'stats') loadStats();
            });
        });

        // Upload functionality
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f0f0f0';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '#fff';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#fff';
            fileInput.files = e.dataTransfer.files;
            handleUpload();
        });

        fileInput.addEventListener('change', handleUpload);

        async function handleUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', document.getElementById('name-input').value || 'Anonymous');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results, 'upload-result');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }

        // Webcam functionality
        let stream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        document.getElementById('start-webcam').addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('start-webcam').style.display = 'none';
                document.getElementById('capture').style.display = 'inline-block';
                document.getElementById('stop-webcam').style.display = 'inline-block';
            } catch (error) {
                alert('Could not access webcam: ' + error.message);
            }
        });

        document.getElementById('capture').addEventListener('click', async () => {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            const name = document.getElementById('webcam-name').value || 'Anonymous';

            try {
                const response = await fetch('/webcam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData, name: name })
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results, 'webcam-result');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Capture failed: ' + error.message);
            }
        });

        document.getElementById('stop-webcam').addEventListener('click', () => {
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('start-webcam').style.display = 'inline-block';
            document.getElementById('capture').style.display = 'none';
            document.getElementById('stop-webcam').style.display = 'none';
        });

        function displayResults(results, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.style.borderLeft = `4px solid ${colors[result.emotion]}`;

                resultDiv.innerHTML = `
                    <h3>Detection ${index + 1}</h3>
                    <p><strong>Emotion:</strong> <span style="color: ${colors[result.emotion]}">${result.emotion}</span></p>
                    <p><strong>Confidence:</strong> ${result.confidence}%</p>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${result.confidence}%; background-color: ${colors[result.emotion]}"></div>
                    </div>
                `;

                container.appendChild(resultDiv);
            });
        }

        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();

                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                if (data.detections.length === 0) {
                    historyList.innerHTML = '<p>No detections yet</p>';
                    return;
                }

                data.detections.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.style.borderLeft = `4px solid ${colors[d.emotion] || '#999'}`;
                    div.innerHTML = `
                        <strong>${d.name}</strong> - ${d.emotion} (${d.confidence?.toFixed(2)}%)
                        <br><small>${new Date(d.timestamp).toLocaleString()} - ${d.type}</small>
                    `;
                    historyList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                const statsContent = document.getElementById('stats-content');
                let html = `<p><strong>Total Detections:</strong> ${data.total_detections}</p>`;

                if (Object.keys(data.emotion_distribution).length > 0) {
                    html += '<h3>Emotion Distribution</h3>';
                    for (const [emotion, count] of Object.entries(data.emotion_distribution)) {
                        const percentage = ((count / data.total_detections) * 100).toFixed(1);
                        html += `
                            <div class="stat-item">
                                <span>${emotion}</span>
                                <div class="stat-bar">
                                    <div class="stat-fill" style="width: ${percentage}%; background-color: ${colors[emotion]}"></div>
                                </div>
                                <span>${count} (${percentage}%)</span>
                            </div>
                        `;
                    }
                }

                statsContent.innerHTML = html || '<p>No data available</p>';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
    </script>
</body>
</html>